<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ตรวจสอบตำแหน่ง</title>
    <style>
      body{font-family:'Prompt',sans-serif;max-width:600px;margin:0 auto;padding:20px;background:#f0f8ff;text-align:center}
      .container{background:#fff;padding:25px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
      h1{color:#2c3e50;margin-bottom:20px}
      button{background:#3498db;color:#fff;border:0;padding:12px 25px;border-radius:8px;cursor:pointer;font-size:16px;transition:background .3s}
      button:hover{background:#2980b9}
      #status{margin-top:20px;padding:15px;border-radius:8px;font-weight:bold}
      .success{background:#d4edda;color:#155724}
      .error{background:#f8d7da;color:#721c24}
      .loading{background:#d1ecf1;color:#0c5460}
      #map{height:300px;margin-top:20px;border-radius:8px}
      .location-info{margin-top:15px;padding:10px;background:#f8f9fa;border-radius:8px;text-align:left}
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ตรวจสอบตำแหน่ง</h1>
      <button id="checkLocation">ตรวจสอบตำแหน่งของฉัน</button>
      <div id="status"></div>
      <div id="locationInfo" class="location-info" style="display:none;"></div>
      <div id="map"></div>
    </div>

    <script>
      const U="https://script.google.com/macros/s/AKfycbwM6sOizdhdNDBd_tAANDmBt0-Ont8QaeG84HZOx4EGSzBj-Zh1zIlgXwespafkLQrFPA/exec";
      const B=a=>document.getElementById(a);
      const S=B("status"),L=B("locationInfo"),T=B("checkLocation"),P=B("map");

      const J=(u,p={},k="callback")=>new Promise((R,E)=>{const c="cb_"+Math.random().toString(36).slice(2);p[k]=c;const q=new URL(u);Object.entries(p).forEach(([x,y])=>q.searchParams.append(x,y));const s=document.createElement("script");window[c]=d=>{H();R(d)};s.onerror=()=>{H();E(new Error("JSONP request failed"))};s.src=q.toString();document.body.appendChild(s);function H(){try{delete window[c]}catch(_){ }s&&s.parentNode&&s.parentNode.removeChild(s)}});

      const I=async()=>{try{const r=await J("https://api.ipify.org/",{format:"jsonp"},"callback");return r&&r.ip?r.ip:""}catch(_){return""}};

      const M=(a,b)=>{P.innerHTML=`<iframe width="100%" height="100%" frameborder="0" scrolling="no" src="https://maps.google.com/maps?q=${a},${b}&hl=th&z=15&output=embed"></iframe>`};

      const C=()=>{S.className="loading";S.textContent="กำลังตรวจสอบตำแหน่ง...";L.style.display="none";
        if(!navigator.geolocation){S.className="error";S.textContent="เบราว์เซอร์ของคุณไม่รองรับ Geolocation API";return}
        navigator.geolocation.getCurrentPosition(async g=>{
          const a=g.coords.latitude,b=g.coords.longitude;
          L.style.display="block";L.innerHTML=`<strong>ข้อมูลตำแหน่งของคุณ:</strong><br>ละติจูด: ${a.toFixed(6)}<br>ลองจิจูด: ${b.toFixed(6)}`;
          const ip=await I();
          const params={latitude:a.toFixed(6),longitude:b.toFixed(6),ip:ip};
          J(U,params,"callback").then(z=>{
            if(z&&z.status==="Success"){
              const d=(z.distance!=null)?Number(z.distance).toFixed(2):"-",ok=z.isWithinRadius;
              S.className=ok===true?"success":(ok===false?"error":"loading");
              S.innerHTML=(ok==null)?`โปรดอนุญาตให้เข้าถึงตำแหน่งเพื่อตรวจสอบ`:`คุณอยู่ห่างจากจุดมุ่งหมาย ${d} กิโลเมตร<br>${ok?"✅ อยู่ในรัศมีที่กำหนด":"❌ ไม่อยู่ในรัศมีที่กำหนด"}<br>✅ บันทึกข้อมูลลง Google Sheets เรียบร้อยแล้ว`;
              M(a,b);
            }else{
              S.className="error";S.innerHTML=`❌ เกิดข้อผิดพลาด: ${z?.message||"Unknown"}`;
            }
          }).catch(e=>{S.className="error";S.innerHTML=`❌ JSONP Error: ${e.message}`})
        },e=>{S.className="error";S.textContent=`เกิดข้อผิดพลาด: ${e.message}`})
      };

      T.addEventListener("click",C);
    </script>
  </body>
</html>
