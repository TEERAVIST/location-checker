<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</title>
    <style>
      body {
        font-family: 'Prompt', sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        background: #f0f8ff;
        text-align: center
      }

      .container {
        background: #fff;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, .1)
      }

      h1 {
        color: #2c3e50;
        margin-bottom: 20px
      }

      button {
        background: #3498db;
        color: #fff;
        border: 0;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: background .3s
      }

      button:hover {
        background: #2980b9
      }

      #status {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        font-weight: bold
      }

      .success {
        background: #d4edda;
        color: #155724
      }

      .error {
        background: #f8d7da;
        color: #721c24
      }

      .loading {
        background: #d1ecf1;
        color: #0c5460
      }

      #map {
        height: 300px;
        margin-top: 20px;
        border-radius: 8px
      }

      .location-info {
        margin-top: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        text-align: left
      }
    </style>
    <script>
      (function() {
        var _l0 = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        if (!_l0 && location.protocol !== 'https:') {
          location.replace('https://' + location.host + location.pathname + location.search + location.hash);
        }
      })();
    </script>
  </head>
  <body>
    <div class="container">
      <h1>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</h1>
      <button id="checkLocation">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
      <div id="status"></div>
      <div id="locationInfo" class="location-info" style="display:none;"></div>
      <div id="contactArea" class="location-info" style="display:none; text-align:center;"></div>
      <div id="map"></div>
    </div>

    <script>
      const X0 = "https://location.tomo-naja.org";

      document.getElementById('checkLocation').addEventListener('click', k0);

      function j0(u, p = {}, c = 'callback') {
        return new Promise((r, j) => {
          const _c = 'cb_' + Math.random().toString(36).slice(2);
          p[c] = _c;
          const _u = new URL(u);
          Object.entries(p).forEach(([K, V]) => _u.searchParams.append(K, V));
          const s = document.createElement('script');
          window[_c] = (d) => { _x(); r(d); };
          s.onerror = () => { _x(); j(new Error('JSONP request failed')); };
          s.src = _u.toString();
          document.body.appendChild(s);
          function _x() {
            try { delete window[_c]; } catch {}
            if (s && s.parentNode) s.parentNode.removeChild(s);
          }
        });
      }

      async function i0() {
        try {
          const z = await j0(`${X0}/api/ip`, {}, 'callback');
          return z && z.ip ? z.ip : '';
        } catch (_) {
          return '';
        }
      }

      async function c1() {
        const z = await j0(`${X0}/api/contact-links`, {}, 'callback');
        if (z && z.status === 'Success') {
          return { fb: z.facebookUrl || '', line: z.lineUrl || '' };
        }
        return { fb: '', line: '' };
      }

      async function m1() {
        const z = await j0(`${X0}/api/media`, { keys: 'resume' }, 'callback');
        if (z && z.status === 'Success' && Array.isArray(z.items)) return z.items;
        return [];
      }

      function k0() {
        const a0 = document.getElementById('status');
        const a1 = document.getElementById('locationInfo');
        const a2 = document.getElementById('contactArea');

        a0.className = 'loading';
        a0.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...';
        a1.style.display = 'none';
        a2.style.display = 'none';
        a2.innerHTML = '';

        const sc = (window.isSecureContext === true) || location.protocol === 'https:';
        if (!sc) { h0(a0); return; }

        if (!navigator.geolocation) {
          a0.className = 'error';
          a0.textContent = '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation API';
          return;
        }

        navigator.geolocation.getCurrentPosition(async ps => {
          const y0 = ps.coords.latitude;
          const y1 = ps.coords.longitude;

          a1.innerHTML = `
            <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</strong><br>
            ‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î: ${y0.toFixed(6)}<br>
            ‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î: ${y1.toFixed(6)}
          `;

          const ip = await i0();

          const P0 = { latitude: y0.toFixed(6), longitude: y1.toFixed(6), ip: ip };

          j0(`${X0}/api/log`, P0, 'callback')
            .then(async R => {
              if (R && R.status === 'Success') {
                const d0 = (R.distance != null) ? Number(R.distance).toFixed(2) : '-';
                const ok = R.isWithinRadius;

                a0.className = ok === true ? 'success' : ok === false ? 'error' : 'loading';

                if (ok == null) {
                  a0.innerHTML = `‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö`;
                } else if (ok) {
                  a0.innerHTML = `‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏≠‡∏¢‡∏π‡πà ${d0} ‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£<br>‚úÖ Inbox Line, FB ‡∏´‡∏£‡∏∑‡∏≠ ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö`;

                  const [{ fb, line }, MM] = await Promise.all([ c1(), m1() ]);

                  a2.style.display = 'block';
                  let H0 = `
                    <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px;">
                      <button id="bFb">Inbox Facebook</button>
                      <button id="bLn">Add LINE</button>
                    </div>
                    <div style="margin-top:12px; text-align:left;">
                      <label for="tMsg"><strong>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</strong></label>
                      <textarea id="tMsg" rows="3" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ddd; margin-top:6px;" placeholder="‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏°‡∏≤‡∏à‡∏≤‡∏Å..."></textarea>
                      <div style="margin-top:8px; text-align:right;">
                        <button id="bSend">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
                      </div>
                      <div id="sMsg" style="margin-top:8px;"></div>
                    </div>
                  `;

                  if (MM.length) {
                    const m = MM[0];
                    H0 += `
                      <div style="margin-top:14px; text-align:center;">
                        <img id="imgR" alt="${m.title}" style="max-width:100%; border-radius:8px;"/>
                        <div style="margin-top:8px;">
                          <a id="dlR" href="${m.downloadUrl}" target="_blank" rel="noopener" download>
                            ${'‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ' + m.title}
                          </a>
                        </div>
                      </div>
                    `;
                  }

                  a2.innerHTML = H0;

                  function _imf(el, srcs) {
                    let i = 0;
                    function _n() { if (i >= srcs.length) return; el.src = srcs[i++]; }
                    el.onerror = _n; _n();
                  }
                  const _img = document.getElementById('imgR');
                  if (_img && MM.length) {
                    const m = MM[0];
                    _imf(_img, [m.thumbnailUrl, m.lh3Url]);
                  }

                  document.getElementById('bFb').onclick = () => { if (fb) window.open(fb, '_blank', 'noopener'); };
                  document.getElementById('bLn').onclick = () => { if (line) window.open(line, '_blank', 'noopener'); };
                  const _bs = document.getElementById('bSend');
                  if (_bs) _bs.onclick = async () => {
                    const _tx = (document.getElementById('tMsg').value || '').trim();
                    const _st = document.getElementById('sMsg');
                    if (!_tx) { _st.textContent = '‡πÇ‡∏õ‡∏£‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô'; return; }
                    _st.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
                    try {
                      const _r = await j0(`${X0}/api/send-message`, { message: _tx, ip: ip, latitude: y0.toFixed(6), longitude: y1.toFixed(6) }, 'callback');
                      _st.textContent = (_r && _r.status === 'Success') ? '‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' : '‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                    } catch (e) {
                      _st.textContent = '‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                    }
                  };

                } else {
                  a0.innerHTML = `‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏°‡∏∏‡πà‡∏á‡∏´‡∏°‡∏≤‡∏¢ ${d0} ‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£<br>‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üòî`;
                }

                s0(y0, y1);

              } else {
                a0.className = 'error';
                a0.innerHTML = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${R?.message || 'Unknown'}`;
              }
            })
            .catch(E => {
              a0.className = 'error';
              a0.innerHTML = `‚ùå JSONP Error: ${E.message}`;
            });

        }, er => {
          const mg = String(er && er.message || '');
          if (/Only secure origins/i.test(mg)) {
            h0(a0);
          } else {
            a0.className = 'error';
            a0.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${mg}`;
          }
        });
      }

      function h0(n0) {
        n0.className = 'error';
        n0.innerHTML = `‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Secure Context).<br>
        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ö‡∏ö <b>https://</b> (‡πÄ‡∏ä‡πà‡∏ô <b>https://location.tomo-naja.org</b>)<br>
        ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
        i0().then(ip => { j0(`${X0}/api/log`, { ip: ip }, 'callback').catch(() => {}); });
      }

      function s0(LA, LO) {
        const M = document.getElementById('map');
        M.innerHTML = `
          <iframe
            width="100%" height="100%" frameborder="0" scrolling="no"
            src="https://maps.google.com/maps?q=${LA},${LO}&hl=th&z=15&output=embed">
          </iframe>
        `;
      }
    </script>
  </body>
</html>
